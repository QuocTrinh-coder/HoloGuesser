<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="classic.css">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Guess the HoloMem</title>
    <style>
        .correct {
            background-color: #79d8a8;
        }
        .incorrect {
            background-color: red;
        }
        .close-answer {
            background-color: #f4572c;
        }
        .up-arrow::after {
            content: ' ↑';
        }
        .down-arrow::after {
            content: ' ↓';
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 1s forwards;
        }
        table {
            border-collapse: collapse; /* Ensures no space between cells */
        }
        #aboutMeBtn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        
        .about-me-image {
            width: 50px;
            height: 50px;
            transition: transform 0.3s;
        }
        
        #aboutMeBtn:hover .about-me-image {
            transform: scale(1.1);
        }

        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .pageInfo{
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class = "main">
        <a href="home.html" class= "title">
            <h1>HoloGuesser</h1>   
        </a>
        <button id="reset-button">Reset for Testing</button>
        <div class="guessbox">
            <div class="input-button-container">
                <div class="IZ-select__input-wrap">
                    <input id="search-input" class="IZ-select__input" placeholder="Type member name ..." type="text" autocomplete="off">
                </div>
                <div class="custom-button-container">
                    <div id="submit-button" class="custom-button">
                        <div class="custom-button-layer layer1"></div>
                        <div class="custom-button-layer layer2"></div>
                        <div class="custom-button-layer layer3"></div>
                        <div class="custom-button-layer layer4"></div>
                    </div>
                </div>
            </div>
            <div class="IZ-select__menu-items" id="menu-items">
                <!-- Options will be inserted here dynamically -->
            </div>
        </div>
        <!-- reset count down area -->
        <div id="countdown"></div>
        <!-- end -->
        <div id="selected-member" class="custom-selected-member"></div>
        <div id="table-container" class="table-container">
            <table id="guess-table">
                <thead>
                    <tr>
                        <th class="name-column">Member</th>
                        <th>Debut Date</th>
                        <th>Group</th>
                        <th>Generation</th>
                        <th>Branch</th>
                        <th>Birthday</th>
                        <th>Status</th>
                        <th>Height</th>
                    </tr>
                </thead>
                <tbody class = "table-body">
                    <!-- Rows will be inserted here dynamically -->
                </tbody>
            </table>
        </div>
        <div class= "rule-container">
            <div id="rule">
                <div class="rule-title">
                    <h3>Color Definitions</h3>
                </div>
                <div class="rule-book">
                    <div class="color-box">
                        <div>
                            <img src="fauna.png" width="50px" height="50px">
                            <span>Correct Answer</span>
                        </div>
                    </div>
                    <div class="color-box">
                        <div>
                            <img src="hakos.png" width="50px" height="50px">
                            <span>Wrong Answer</span>
                        </div>
                    </div>
                    <div class="color-box">
                        <div>
                            <img src="shocking_kiara.jpg" width="50px" height="50px">
                            <span>Close Answer</span>
                        </div>
                    </div>
                    <div class="color-box">
                        <div>
                            <img src="https://www.svgrepo.com/show/181247/upload-arrows.svg" width="50px" height="50px">
                            <span>Too Low</span>
                        </div>
                    </div>
                    <div class="color-box">
                        <div>
                            <img src="https://www.svgrepo.com/show/181248/download-arrows.svg" width="50px" height="50px">
                            <span>Too High</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="other-modes">
            <h3 class="other-modes-title">Other Game Modes</h3>
            <div id="other-games-buttons" class="button-container">
                <a href="classic.html" class="button-wrapper">
                    <img src="classic_mode.png" alt="Button 1" class="button-image" id="button1">
                    <span class="button-label">Classic Mode</span>
                </a>
                <a href="music.html" class="button-wrapper">
                    <img src="music_icon.png" alt="Button 2" class="button-image" id="button1">
                    <span class="button-label">Singer Mode</span>
                </a>
                <a href="fanbase.html" class="button-wrapper">
                    <img src="fanbase_mode.png" alt="Button 3" class="button-image" id="button2">
                    <span class="button-label">Fanbase Mode</span>
                </a>
                <a href="stream.html" class="button-wrapper">
                    <img src="stream_mode.png" alt="Button 4" class="button-image" id="button3">
                    <span class="button-label">Stream Mode</span>
                </a>
            </div>
        </div>
        
        <div class = "pageInfo">
            <button id="aboutMeBtn">
                <img src="https://cdn.pixabay.com/photo/2012/04/23/15/41/question-38595_1280.png" alt="About Me" class="about-me-image">
            </button>
        </div>

        <div id="aboutMeModal" class="modal">
            <div class="modal-container">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>About Me</h2>
                    <p>This is the About Me information. You can add a lot of text here...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <p>More content...</p>
                    <!-- Add more content as needed -->
                </div>
            </div>
        </div>
            
        </div>
    </div>
    <div id="confetti-container"></div>
    <script>
        const PAGE_KEY_PREFIX = 'classic_mode_'; // Unique prefix for this page or functionality

        function setLocalStorage(key, value) {
            localStorage.setItem(PAGE_KEY_PREFIX + key, value);
        }
        
        function getLocalStorage(key) {
            return localStorage.getItem(PAGE_KEY_PREFIX + key);
        }
        
        function removeLocalStorage(key) {
            localStorage.removeItem(PAGE_KEY_PREFIX + key);
        }
        let members = [];
        let selectedMember = null;
        let randomMember = null;
        let guessedMembers = JSON.parse(getLocalStorage('guessedMembers')) || [];
        let isFirstGuess = false;
        let correctGuess = getLocalStorage('correctGuess') === 'true';
        const baseUrl = 'http://localhost:3000/randomMember';
        
        // Fetch members data from the JSON file
        fetch('hololive_members.json')
            .then(response => response.json())
            .then(data => {
                members = Object.keys(data).map(name => ({
                    name: name,
                    img: data[name].ImageURL,
                    debut: data[name].Debut_Date,
                    group: data[name].Group,
                    generation: data[name].Generation,
                    branch: data[name].Branch,
                    birthday: data[name].Birthday,
                    status: data[name].Status,
                    height: parseHeight(data[name].Height),
                    fullHeight: data[name].Height
                }));
            })
            .catch(error => console.error('Error fetching member data:', error));

        fetch(baseUrl)
            .then(res => {
                if (!res.ok) {
                    throw new Error('Network response was not ok');
                }
                return res.json();
            })
            .then(random_number => {
                console.log(random_number); // This will log the object { randomNumber: <number> }
                randomMember = members[random_number[0]]; // Access the random number from the data
                console.log('Random Number:', randomMember);
                setLocalStorage('randomMember', JSON.stringify(randomMember));
                // Handle the fetched random number here
                resetDailyMember();
                updateGuessList();
                startCountdown(); // Start the countdown timer
            })
            .catch(error => console.error('Error fetching random number:', error));

        const searchInput = document.getElementById('search-input');
        const menuItems = document.getElementById('menu-items');
        const submitButton = document.getElementById('submit-button');
        const selectedMemberDiv = document.getElementById('selected-member');
        const guessTableBody = document.querySelector('#guess-table tbody');
        const tableContainer = document.getElementById('table-container');
        const confettiContainer = document.getElementById('confetti-container');
        const modal = document.getElementById("aboutMeModal");
        const btn = document.getElementById("aboutMeBtn");
        const span = document.getElementsByClassName("close")[0];
        const countdownElement = document.getElementById('countdown'); // Element to display the countdown timer
        
        // Initially hide the guess table
        tableContainer.style.display = 'none';
        
        // Disable the submit button if the correct member has already been guessed
        if (correctGuess) {
            submitButton.style.pointerEvents = 'none';
            submitButton.style.opacity = '0.5';
        }
        
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            menuItems.innerHTML = '';
        
            if (query) {
                const filteredMembers = members
                    .filter(member => !guessedMembers.includes(member.name))
                    .filter(member => member.name.toLowerCase().includes(query));
                filteredMembers.forEach(member => {
                    const item = document.createElement('div');
                    item.classList.add('IZ-select__item');
                    item.innerHTML = `
                        <div class="select-content">
                            <div><img src="${member.img}" width="40px" height="40px"></div>
                            <div>${member.name}</div>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        selectedMember = member;
                        searchInput.value = member.name;
                        menuItems.style.display = 'none';
                    });
                    menuItems.appendChild(item);
                });
                menuItems.style.display = 'block';
            } else {
                menuItems.style.display = 'none';
            }
        });
        
        submitButton.addEventListener('click', () => {
            if (selectedMember && !correctGuess) {
                if (!guessedMembers.includes(selectedMember.name)) {
                    addMemberToTable(selectedMember);
                    guessedMembers.push(selectedMember.name);
                    setLocalStorage('guessedMembers', JSON.stringify(guessedMembers));
        
                    searchInput.value = '';
                    menuItems.style.display = 'none';
        
                    if (!isFirstGuess) {
                        tableContainer.style.display = 'none'; // Show table after first guess
                        isFirstGuess = true;
                    }
        
                    if (selectedMember.name === randomMember.name) {
                        correctGuess = true;
                        setLocalStorage('correctGuess', 'true'); // Save correct guess state to local storage
                        submitButton.style.pointerEvents = 'none';
                        submitButton.style.opacity = '0.5';
                        showConfetti();
                    }
                }
            }
        });
        
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.guessbox')) {
                menuItems.style.display = 'none';
            }
        });
        
        
        function addMemberToTable(member, skipAnimation = false) {
            const newRow = document.createElement('tr');
        
            const heightComparison = compareHeight(member.height, randomMember.height);
            const heightDisplay = `${member.fullHeight} ${heightComparison.arrow}`;
            const birthdayClose = isBirthdayClose(member.birthday, randomMember.birthday);
            const debutComparison = compareDebut(member.debut, randomMember.debut);
        
            newRow.innerHTML = `
                <td class="guessed-pic"><img src="${member.img}" width="60px" height="60px"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            `;
        
            guessTableBody.insertBefore(newRow, guessTableBody.firstChild);
        
            const cells = newRow.querySelectorAll('td');
        
            if (skipAnimation) {
                // Skip animations if specified
                cells[1].innerHTML = `${member.debut} ${debutComparison.arrow}`;
                cells[1].classList.add(debutComparison.class);
        
                cells[2].textContent = member.group;
                cells[2].classList.add(member.group === randomMember.group ? 'correct' : 'incorrect');
        
                cells[3].textContent = member.generation;
                cells[3].classList.add(member.generation === randomMember.generation ? 'correct' : 'incorrect');
        
                cells[4].textContent = member.branch;
                cells[4].classList.add(member.branch === randomMember.branch ? 'correct' : 'incorrect');
        
                cells[5].textContent = member.birthday;
                if (member.birthday === randomMember.birthday) {
                    cells[5].classList.add('correct');
                } else if (birthdayClose) {
                    cells[5].classList.add('close-answer');
                } else {
                    cells[5].classList.add('incorrect');
                }
        
                cells[6].textContent = member.status;
                cells[6].classList.add(member.status === randomMember.status ? 'correct' : 'incorrect');
        
                cells[7].innerHTML = heightDisplay;
                cells[7].classList.add(heightComparison.class);
            } else {
                // Trigger animations for new guesses
                setTimeout(() => {
                    cells[1].innerHTML = `${member.debut} ${debutComparison.arrow}`;
                    cells[1].classList.add('fade-in', debutComparison.class);
                }, 200);
        
                setTimeout(() => {
                    cells[2].textContent = member.group;
                    cells[2].classList.add('fade-in', member.group === randomMember.group ? 'correct' : 'incorrect');
                }, 800);
        
                setTimeout(() => {
                    cells[3].textContent = member.generation;
                    cells[3].classList.add('fade-in', member.generation === randomMember.generation ? 'correct' : 'incorrect');
                }, 1400);
        
                setTimeout(() => {
                    cells[4].textContent = member.branch;
                    cells[4].classList.add('fade-in', member.branch === randomMember.branch ? 'correct' : 'incorrect');
                }, 2000);
        
                setTimeout(() => {
                    cells[5].textContent = member.birthday;
                    if (member.birthday === randomMember.birthday) {
                        cells[5].classList.add('fade-in', 'correct');
                    } else if (birthdayClose) {
                        cells[5].classList.add('fade-in', 'close-answer');
                    } else {
                        cells[5].classList.add('fade-in', 'incorrect');
                    }
                }, 2600);
        
                setTimeout(() => {
                    cells[6].textContent = member.status;
                    cells[6].classList.add('fade-in', member.status === randomMember.status ? 'correct' : 'incorrect');
                }, 3200);
        
                setTimeout(() => {
                    cells[7].innerHTML = heightDisplay;
                    cells[7].classList.add('fade-in', heightComparison.class);
                }, 3600);
            }
        
            if (!isFirstGuess) {
                // Show table after the first guess
                tableContainer.style.display = 'block';
                guessTableBody.style.display = 'table-row-group'; // Ensure tbody is displayed as table-row-group
                isFirstGuess = true;
            }
        }
        
        function parseHeight(heightString) {
            const cmPart = heightString.split(' ')[0];
            return parseInt(cmPart.replace('cm', ''), 10);
        }
        
        function compareHeight(guessedHeight, randomHeight) {
            if (guessedHeight === randomHeight) {
                return { arrow: '', class: 'correct' };
            } else if (guessedHeight < randomHeight) {
                return { arrow: '⬆', class: 'incorrect' };
            } else {
                return { arrow: '⬇', class: 'incorrect' };
            }
        }
        
        function compareDebut(guessedDebut, randomDebut) {
            const guessedDate = new Date(guessedDebut);
            const randomDate = new Date(randomDebut);
            const correct = guessedDate.getTime() === randomDate.getTime();
        
            if (correct) {
                return { arrow: '', class: 'correct' };
            } else if (guessedDate < randomDate) {
                return { arrow: '⬆', class: 'incorrect' };
            } else {
                return { arrow: '⬇', class: 'incorrect' };
            }
        }
        
        function isBirthdayClose(guessedBirthday, randomBirthday) {
            const guessedDate = new Date(guessedBirthday);
            const randomDate = new Date(randomBirthday);
            const timeDifference = Math.abs(randomDate - guessedDate);
            const daysDifference = timeDifference / (1000 * 60 * 60 * 24);
            return daysDifference <= 30;
        }
        
        function createConfettiElement() {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 2 + 's';
            return confetti;
        }
        
        function showConfetti() {
            confettiContainer.innerHTML = '';
        
            const emoteImages = [
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
                'botan.png', 'fubuki.png', 'kiara.png', 'suisei.png', 'watame.png',
            ];
        
            for (let i = 0; i < emoteImages.length; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundImage = `url('${emoteImages[i]}')`;
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * 100}vh`;
                confettiContainer.appendChild(confetti);
            }
        }
        
        function resetDailyMember() {
            const now = new Date();
            const resetHour = 23; // 11 PM in local time
            let resetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), resetHour);
        
            // If the current time is past the reset time, set resetTime to 11 PM the next day
            if (now > resetTime) {
                resetTime.setDate(resetTime.getDate() + 1);
            }
        
            const savedResetTime = getLocalStorage('resetTime');
            if (!savedResetTime || new Date(savedResetTime) < now) {
                setLocalStorage('resetTime', resetTime.toISOString());
                setLocalStorage('randomMember', JSON.stringify(randomMember));
                setLocalStorage('guessedMembers', JSON.stringify([])); // Reset guessed members
                setLocalStorage('correctGuess', 'false'); // Reset correct guess state
                guessedMembers = []; // Clear local guessedMembers array
                correctGuess = false; // Reset correctGuess variable
                document.getElementById('submit-button').style.pointerEvents = 'auto'; // Enable the submit button
                document.getElementById('submit-button').style.opacity = '1.0'; // Reset button opacity
                startCountdown(); // Restart countdown
            } else {
                randomMember = JSON.parse(getLocalStorage('randomMember'));
            }
        }
        
        function updateGuessList() {
            guessedMembers.forEach(memberName => {
                const member = members.find(m => m.name === memberName);
                if (member) {
                    addMemberToTable(member, true); // Skip animation for loaded guesses
                }
            });
        }
        
        // Countdown timer
        function startCountdown() {
            const now = new Date();
            const resetHour = 23; // 11 PM in local time
            let nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate(), resetHour);
            
            // If the current time is past the reset time, set nextReset to 11 PM the next day
            if (now > nextReset) {
                nextReset.setDate(nextReset.getDate() + 1);
            }
            
            const timeRemaining = nextReset - now;
            updateCountdownDisplay(timeRemaining);
            
            const countdownInterval = setInterval(() => {
                const now = new Date();
                const timeRemaining = nextReset - now;
                
                if (timeRemaining <= 0) {
                    clearInterval(countdownInterval);
                    resetDailyMember();
                    startCountdown();
                    resetForTesting();
                    location.reload(); // Refresh the page when the countdown reaches zero
                } else {
                    updateCountdownDisplay(timeRemaining);
                }
            }, 1000);
        }
        
        function updateCountdownDisplay(timeRemaining) {
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
        
            countdownElement.textContent = `Next reset in: ${hours}h ${minutes}m ${seconds}s`;
        }
        
        // Modal event listeners
        btn.onclick = function() {
            modal.classList.add('show');
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.classList.remove('show');
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        }     
        
        // Function to clear local storage and reload for testing
        function resetForTesting() {
            // Function to remove all keys with the specific PAGE_KEY_PREFIX
            function clearPageLocalStorage() {
                // Get all keys from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(PAGE_KEY_PREFIX)) {
                        removeLocalStorage(key.replace(PAGE_KEY_PREFIX, ''));
                    }
                }
            }
        
            clearPageLocalStorage();
            location.reload(); // Reload the page to apply changes
        }
        
        document.getElementById('reset-button').addEventListener('click', () => {
            resetForTesting();
        });
    </script>
    </body>
    </html>

